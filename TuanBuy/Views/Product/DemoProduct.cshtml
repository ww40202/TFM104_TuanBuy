<!--昌浚寫的 後端志輝-->
<link rel="stylesheet" href="~/css/image.css" type="text/css">
<body class="colerwhite">
    <div class="container" id="app">
        <div class="row">
            <div class="col-lg-8">
                <!--商品圖片-->
                <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
                    <ol class="carousel-indicators">
                        <li data-target="#carouselExampleIndicators" :data-slide-to="index" v-for="(item,index) in productData.productPicPath" v-if="index >= 1"></li>
                        <li data-target="#carouselExampleIndicators" :data-slide-to="index" class="active" v-else></li>
                    </ol>
                    <div class="carousel-inner">
                        <div class="carousel-item" v-for="(item,index) in productData.productPicPath" v-if="index >= 1">
                            <img class="d-block w-100" :src="item" style="height:400px;width:250px;" alt="First slide">
                        </div>
                        <div class="carousel-item active" v-else>
                            <img class="d-block w-100" :src="item" style="height:400px;width:250px;" alt="First slide">
                        </div>
                    </div>
                    <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="sr-only">Previous</span>
                    </a>
                    <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="sr-only">Next</span>
                    </a>
                </div>
            </div>

            <div class="col-lg-4">

                <!--分類-->
                <div class="take">
                    產品種類
                    <div class="lable">\</div>
                    <a href="">{{productData.productCategory}}</a>
                </div>
                <div class="Productname">
                    <a class="descriptionblock" href="">
                        <!--商品名稱-->
                        <h2 class="description">{{productData.productTitle}}</h2>
                    </a>
                    <div class="concern">
                        <span class="master">團主</span>
                        <a class="personname" v-bind:href="productData.sellerhref">{{productData.seller}}</a>
                        <a v-on:click="AddChat" v-if="sellerId!==useUserId && useUserId!==undefined">聊聊</a>
                    </div>
                    <!--商品內容-->
                    <p>{{productData.productDescription}}</p>
                    <div class="price">
                        <div class="price">目標金額NT${{productData.productTargetPrice}}</div>
                        <div class="progress">
                            <div class="progress-bar" role="progressbar" v-bind:style="{width:productData.percentage,borderColor:productData.color}" aria-valuenow="25"
                                 aria-valuemin="0" aria-valuemax="100">{{productData.percentage}}</div>
                        </div>
                        <div class="price">單價NT${{productData.productPrice}}</div>
                        <div class="line">
                            <div class="nav nav-list"></div>
                        </div>
                        <div class="purchase">
                            <span>參與團購人數</span>
                            <span>{{productData.buyers}}</span>
                        </div>
                        <div class="purchase">
                            <span>剩餘時間</span>
                            <span>{{productData.productLastTime}}</span>
                        </div>
                        <div class="purchase">
                            <span>時程</span>
                            <span>{{productData.productStartTime}}~{{productData.productEndTime}}</span>
                        </div>
                        <div class="Buy">
                            <span class="stepper">
                                <button>–</button>
                                <input type="number" id="stepper" value="1" min="0" max="100" step="1" readonly>
                                <button>+</button>
                            </span>
                            <button type="button" class="btn btn-danger" v-on:click="AddProductToMe">加入團購</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="bottomblock">
            <div class="row">
                <div class="col">
                    <ul class="nav nav-tabs justify-content-start navtabbottom" id="myTab" role="tablist">
                        <li class="nav-item" role="presentation">
                            <a class="nav-link active" id="spec-tab" data-toggle="tab" href="#spec" role="tab"
                               aria-controls="spec" aria-selected="true">產品規格</a>
                        </li>
                        <li class="nav-item" role="presentation" v-on:click="getMessage">
                            <a class="nav-link" id="message-tab" data-toggle="tab" href="#message" role="tab"
                               aria-controls="message" aria-selected="false">留言</a>
                        </li>
                    </ul>
                    <div class="tab-content" id="myTabContent">
                        <div class="tab-pane fade show active" id="spec" role="tabpanel" aria-labelledby="spec-tab">
                            <div class="row">
                                <div class="col-8">
                                    <div>
                                    </div>
                                    <div>
                                        <tr>
                                            <td>
                                                <h2>
                                                    {{productData.productDescription}}
                                                    <img src="" alt="">
                                                </h2>
                                                <div class="item">
                                                    <img src="" alt="">
                                                </div>
                                                <div class="item">
                                                    <img src="" alt="">
                                                </div>

                                                <div class="item">
                                                    <h6></h6>
                                                    <img src="" alt="">
                                                    <h6 class="productfont">
                                                        {{productData.productSummary}}
                                                    </h6>
                                                </div>
                                                <div class="item">
                                                    <img src="" alt="">
                                                    <h6 class="productfont">
                                                        而火的既視感被德國特製陶瓷玻璃看得不要不要，啪滋啪滋聲就是露營追求的信仰聲 .ᐟ

                                                        偷偷跟你說 … PILMOA
                                                        迷你露營燒柴爐跟同價位的燒柴爐相比，唯一有超耐熱玻璃窗。讓火不再是只可遠觀，不可褻玩焉。盡情在露營時，愛火、玩火、觀火
                                                        .ᐟ
                                                        是貨真價實的好「火」伴 .ᐟ
                                                    </h6>
                                                </div>
                                            </td>
                                        </tr>
                                    </div>
                                </div>
                                <div class="col-4">
                                    <!--廣告-->
                                    <div class="ad">
                                        <div class="adcss">
                                            <div class="adhot">
                                                HOT
                                            </div>
                                            <a href="">
                                                <div style="text-align: center;">
                                                    <img src="" alt="">
                                                </div>
                                                <div>
                                                    <h5>
                                                        <strong style="color: black">ATOLL 快轉機身環 | 最靈活的相機角度調整配件</strong>
                                                    </h5>
                                                    <p>
                                                        團主 by
                                                        <a href="">Harry Wang</a>
                                                    </p>
                                                    <p>ATOLL 是相機的角度調整環，具有腳架環的功能，但裝在機身上，超便利流暢的操作體驗，彷如相機的一部份</p>
                                                </div>
                                                <div>
                                                    <span>剩餘14天</span>
                                                    <span>金額987</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="ad">
                                        <div class="adcss">
                                            <div class="adhot">
                                                HOT
                                            </div>
                                            <a href="">
                                                <div style="text-align: center;">
                                                    <img src="" alt="">
                                                </div>
                                                <div>
                                                    <h5>
                                                        <strong style="color: black">ATOLL 快轉機身環 | 最靈活的相機角度調整配件</strong>
                                                    </h5>
                                                    <p>
                                                        團主 by
                                                        <a href="">Harry Wang</a>
                                                    </p>
                                                    <p>ATOLL 是相機的角度調整環，具有腳架環的功能，但裝在機身上，超便利流暢的操作體驗，彷如相機的一部份</p>
                                                </div>
                                                <div>
                                                    <span>剩餘14天</span>
                                                    <span>金額987</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="ad">
                                        <div class="adcss">
                                            <div class="adhot">
                                                HOT
                                            </div>
                                            <a href="">
                                                <div style="text-align: center;">
                                                    <img src="" alt="">
                                                </div>
                                                <div>
                                                    <h5>
                                                        <strong style="color: black">ATOLL 快轉機身環 | 最靈活的相機角度調整配件</strong>
                                                    </h5>
                                                    <p>
                                                        團主 by
                                                        <a href="">Harry Wang</a>
                                                    </p>
                                                    <p>ATOLL 是相機的角度調整環，具有腳架環的功能，但裝在機身上，超便利流暢的操作體驗，彷如相機的一部份</p>
                                                </div>
                                                <div>
                                                    <span>剩餘14天</span>
                                                    <span>金額987</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                    <div class="ad">
                                        <div class="adcss">
                                            <div class="adhot">
                                                HOT
                                            </div>
                                            <a href="">
                                                <div style="text-align: center;">
                                                    <img src="" alt="">
                                                </div>
                                                <div>
                                                    <h5>
                                                        <strong style="color: black">ATOLL 快轉機身環 | 最靈活的相機角度調整配件</strong>
                                                    </h5>
                                                    <p>
                                                        團主 by
                                                        <a href="">Harry Wang</a>
                                                    </p>
                                                    <p>ATOLL 是相機的角度調整環，具有腳架環的功能，但裝在機身上，超便利流暢的操作體驗，彷如相機的一部份</p>
                                                </div>
                                                <div>
                                                    <span>剩餘14天</span>
                                                    <span>金額987</span>
                                                </div>
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tab-pane fade" id="message" role="tabpanel" aria-labelledby="message-tab">
                            <div v-if="useUserId!=undefined && useUserId!==sellerId">
                                <input required='' type='text' v-model="messageSendContent" v-on:keyup.enter="sendMessage">
                                <label alt='留下你的評論吧!' placeholder='按下Enter送出'></label>
                            </div>
                            <div class="speak" v-else-if="useUserId==undefined">
                                <p>趕快登入留言你的評論!</p>
                            </div>
                            <!-- Featured on LittleBigDetails -->
                            <div class="container">
                                <!--對話內容留言板-->
                                <div class="container">
                                    <div class="headpic" v-for="(item,index) in leaveMessages">
                                        <div class="headpic1">
                                            <img class="imge" style="height:50px;width:50px" :src="item.messagePicPaht" alt="">
                                            <a class="name" href="">{{item.messageName}}</a>
                                        </div>
                                        <div class="speak1">
                                            <p>{{item.messageContent}}</p>
                                        </div>
                                        @*團主回覆可日後實作*@
                                        <div class="speak" v-if="item.sellerReply !==null && item.sellerReply !==''">
                                            <div>
                                                <a href="">{{item.sellerName}}</a>
                                                <span>團主</span>
                                            </div>
                                            <div>
                                                <p>{{item.sellerReply}}</p>
                                            </div>
                                        </div>
                                        <div class="speak" v-else-if="useUserId==sellerId">
                                            <input required='' :id="item.messageId" type='text' v-on:keyup.enter="sendSellerReply(event,index)">
                                            <label alt='趕快回覆他的問題吧!' placeholder='按下Enter送出'></label>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
<script>
    const options = {
        year: 'numeric',    // 年: 使用4位數
        month: '2-digit',   // 月: 使用2數位
        day: '2-digit',     // 日: 使用2數位
        hour12: false,      // 12小時制: 不使用
    };
    //抓取Url資訊
    let str = window.location.pathname.split("/");
    /*抓取Url id*/
    let prdid = str[str.length - 1];    
    class ProductData {
        productId = 0;
        buyers = 0;
        buyersSumPrice = 0;
        buyersSumPricePT = 0;
        productCategory = '';
        productDescription = '';
        productEndTime = '';
        productLastTime = '';
        productStartTime = '';
        productSummary = '';
        productTargetPrice = 0;
        productPrice = 0;
        productTitle = '';
        productPicPath = [];
        sellerhref = '';
        sellerChatHref = '';
        seller = '';
        sellerId = 0;
        percentage = null;
        color = null;
    }
    class Message {
        messageId = 0;
        messageName = '';
        messagePicPaht = '';
        messageDateTime = '';
        messageContent = '';
        sellerName = '';
        sellerReply = '';
        replyDateTime = '';
    }
    var app = new Vue({
        el: "#app",
        data: {
            productData: new ProductData(),
            messageSendContent: '',
            useUserId: null,
            userUserPicPath: null,
            userUserName:null,
            sellerId: null,
            sellerName :null,
            leaveMessages: [],
        },
        methods: {
            getMessage: function () {
                console.log('點擊取得留言');
                $.ajax({
                    type: "get",
                    url: "/Product/GetProductMessage?id=" + this.productData.productId,
                    success: function (response) {
                        //將先前留言清空
                        app.leaveMessages = [];
                        console.log(response);
                        for (let i = 0; i < response.length; i++) {
                            var messageObject = new Message();
                            messageObject.messageId = response[i].messageId;
                            messageObject.messageDateTime = new Date(response[i].messageDateTime).toLocaleString();
                            messageObject.messageContent = response[i].messageContent;
                            messageObject.messageName = response[i].messageName;
                            messageObject.messagePicPaht = '/MemberPicture/' + response[i].messagePicPaht;
                            messageObject.replyDateTime = new Date(response[i].replyDateTime).toLocaleString();
                            messageObject.sellerReply = response[i].sellerReply;
                            messageObject.sellerName = response[i].sellerName;
                            app.leaveMessages.push(messageObject);
                        }
                        console.log(app.leaveMessages);
                    },
                    error: function (response) {
                        alert(response);
                    }
                });
            },

            sendMessage: function () {
                $.ajax({
                    type: "POST",
                    url: "/Product/AddProductMessage",
                    data: {
                        ProductId: app.productData.productId,
                        UserId: app.useUserId,
                        MessageContent: app.messageSendContent
                    },
                    success: function (response) {
                        var leaveObject = new Message();
                        leaveObject.messageContent = app.messageSendContent;
                        leaveObject.messageName = app.userUserName;
                        leaveObject.messagePicPaht = app.userUserPicPath;
                        //將資料存入陣列第一個元素 unshift
                        app.leaveMessages.unshift(leaveObject);
                        app.messageSendContent = '';
                    },
                    error: function (response) {
                        alert(response);
                    }
                });
            },

            sendSellerReply: function (event,index) {
                console.log(event.target);
                console.log(app.leaveMessages);               
                $.ajax({
                    type: "POST",
                    url: "/Product/AddSellerMessage",
                    data: {
                        ProductMessageId: event.target.id,
                        SellerId: app.sellerId,
                        MessageContent: event.target.value
                    },
                    success: function (response) {
                        var result = app.leaveMessages.find(x => x.messageId == event.target.id);
                        result.sellerName = app.sellerName;
                        result.sellerReply = event.target.value;
                    },
                    error: function (response) {
                        alert(response);
                    }
                });
            },

            AddChat: function () {
                $.ajax({
                    type: "POST",
                    url: "/Member/AddChatRoom",
                    data: {
                        SellerId: app.sellerId,
                        MemberId: app.useUserId
                    },
                    success: function (response) {
                        window.location.href = '/Member/chatRoom/';
                    },
                    error: function (response) {
                        alert(response);
                    }
                });
            }
            ,
            AddProductToMe: function () {
                $.ajax({
                    type: "POST",
                    url: "/Product/AddProductOrder",
                    data: {
                        UserId: app.useUserId,
                        ProductId: app.productData.productId,
                    },
                    success: function (response) {
                        window.location.href = '/Product/checkout/';
                    },
                    error: function (response) {
                        alert(response);
                    }
                });
            },
        },
        mounted: function () {
            axios.get("/Product/GetProductData/" + prdid).then((resp) => {
                console.log(resp);
                this.productData.productId = resp.data.id;
                if (resp.data.buyers !== null) { this.productData.buyers = resp.data.buyers; }
                this.productData.productCategory = resp.data.productCategory;
                this.productData.productDescription = resp.data.productDescription;
                this.productData.productId = resp.data.id;
                this.productData.productStartTime = new Intl.DateTimeFormat('zh-TW', options).format(new Date(resp.data.productStartTime));
                this.productData.productEndTime = new Intl.DateTimeFormat('zh-TW', options).format(new Date(resp.data.productEndTime));
                this.productData.productLastTime = resp.data.productLastTime;
                this.productData.productSummary = resp.data.productSummary;
                this.productData.productTargetPrice = resp.data.productTargetPrice;
                this.productData.productPrice = resp.data.productPrice;
                this.productData.productTitle = resp.data.productTitle;
                this.productData.sellerhref = '/MemberCenter/mystoresell/' + resp.data.sellerId;
                this.productData.sellerChatHref = '/Member/AddChatRoom/' + resp.data.sellerId;
                this.productData.seller = resp.data.seller;
                this.productData.sellerId = resp.data.sellerId;
                this.productData.buyersSumPrice = resp.data.buyersSumPrice;
                this.productData.color = resp.data.color;
                this.productData.percentage = resp.data.percentage;
                app.sellerId = resp.data.sellerId;
                app.sellerName = resp.data.seller
                for (var item in resp.data.productPicPath) {
                    this.productData.productPicPath.push(resp.data.productPicPath[item]);
                }
                console.log(app.sellerId);
                console.log(app.useUserId);
            }),

            axios.get("/Member/GetOnlineMember/").then((resp) => {
                    app.useUserId = resp.data.id;
                    app.userUserPicPath = '/MemberPicture/' + resp.data.picPath;
                    app.userUserName = resp.data.nickName;
                    console.log(resp);
                }),
                console.log(this.productData);
        },
        computed: {
            //計算商品單價總額
            productShoppingSum: function () {
                return (index) => {
                    return app.productShoppings[index].productPrice * app.productShoppings[index].productCount
                }
                /*return app.productShoppings[index].productPrice * app.productShoppings[index].productCount;*/
            },
        },
    });

</script>

<!--切換分頁-->

<script>
    var inc = document.getElementsByClassName("stepper");
    for (i = 0; i < inc.length; i++) {
        var incI = inc[i].querySelector("input"),
            id = incI.getAttribute("id"),
            min = incI.getAttribute("min"),
            max = incI.getAttribute("max"),
            step = incI.getAttribute("step");
        document
            .getElementById(id)
            .previousElementSibling.setAttribute(
                "onclick",
                "stepperInput('" + id + "', -" + step + ", " + min + ")"
            );
        document
            .getElementById(id)
            .nextElementSibling.setAttribute(
                "onclick",
                "stepperInput('" + id + "', " + step + ", " + max + ")"
            );
    }
    //團購按鈕
    function stepperInput(id, s, m) {
        var el = document.getElementById(id);
        if (s > 0) {
            if (parseInt(el.value) < m) {
                el.value = parseInt(el.value) + s;
            }
        } else {
            if (parseInt(el.value) > m) {
                el.value = parseInt(el.value) + s;
            }
        }
    }
</script>
